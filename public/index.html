<!DOCTYPE html>
<html>
<head>
  <title>BUY / SELL / HOLD</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="hero">
    <div class="hero-content">
      <h1>AI Investor Insights</h1>
      <div class="auth-links">
        <a href="#">Login</a>
        <a href="#">Sign Up</a>
      </div>
    </div>
  </div>
  
  <div class="main-content">
    <div class="container">
      <h1>BUY / SELL / HOLD</h1>
      <h2>AI analysis of latest quarterly filing</h2>
      <div class="input-group">
        <input type="text" id="symbol" placeholder="Enter stock symbol (e.g., AAPL)" required>
        <div class="button-group">
          <button onclick="fetchAndAnalyze()" id="analyzeBtn">Analyze Financials</button>
        </div>
      </div>
      <div id="result"></div>
      <div id="priceInfo" class="price-info" style="display: none;"></div>
      <div id="analysis"></div>
      <div class="disclaimer">
        The information provided on this page are generated using AI and are intended for informational purposes only. They do not constitute financial advice.
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <p>© 2025 AI Investor Insights. All rights reserved.</p>
      <p>
        <a href="#">Privacy Policy</a> | 
        <a href="#">Terms of Service</a> | 
        <a href="#">Contact Us</a>
      </p>
    </div>
  </footer>

  <script>
    async function fetchAndAnalyze() {
      const symbol = document.getElementById('symbol').value.toUpperCase();
      const resultDiv = document.getElementById('result');
      const priceInfoDiv = document.getElementById('priceInfo');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analysisDiv = document.getElementById('analysis');

      if (!symbol) {
        showResult('Please enter a stock symbol', 'error');
        return;
      }

      resultDiv.innerHTML = '';
      priceInfoDiv.style.display = 'none';
      analysisDiv.style.display = 'block';
      analysisDiv.innerHTML = 'Fetching financial data...';
      analyzeBtn.disabled = true;

      try {
        // Step 1: Fetch latest 10-Q + price info
        const fetchResponse = await fetch('/fetch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol })
        });

        const fetchData = await fetchResponse.json();
        if (!fetchResponse.ok) {
          throw new Error(fetchData.error || 'Failed to fetch financials.');
        }

        showResult(fetchData.message, 'success');

        if (fetchData.filingPrice && fetchData.currentPrice) {
          const priceChange = ((fetchData.currentPrice - fetchData.filingPrice) / fetchData.filingPrice * 100).toFixed(2);
          const priceChangeClass = priceChange >= 0 ? 'price-up' : 'price-down';
          const priceChangeSymbol = priceChange >= 0 ? '↑' : '↓';

          priceInfoDiv.innerHTML = `
            <p>Filing Date: ${new Date(fetchData.filingDate).toLocaleDateString()}</p>
            <p>Price at Filing: $${fetchData.filingPrice.toFixed(2)}</p>
            <p>Current Price: $${fetchData.currentPrice.toFixed(2)}</p>
            <p class="price-change ${priceChangeClass}">
              Change: ${priceChangeSymbol} ${Math.abs(priceChange)}%
            </p>
          `;
          priceInfoDiv.style.display = 'block';
        }

        // Step 2: Analyze
        analysisDiv.innerHTML = 'Analyzing financial data...';

        const analyzeResponse = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol })
        });

        const analyzeData = await analyzeResponse.json();
        if (!analyzeResponse.ok) {
          throw new Error(analyzeData.error || 'Failed to analyze.');
        }

        const filingDate = fetchData.filingDate;
        analysisDiv.innerHTML = `<h3>Financial analysis based on last quarterly report filed on ${new Date(filingDate).toLocaleDateString()}</h3>${analyzeData.analysis}`;
      } catch (err) {
        showResult(err.message, 'error');
        analysisDiv.innerHTML = '';
        priceInfoDiv.style.display = 'none';
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    function showResult(message, type) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';
      resultDiv.className = type;
    }
  </script>
</body>
</html>
